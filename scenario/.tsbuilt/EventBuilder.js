"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildContractFetcher = exports.buildContractEvent = void 0;
const World_1 = require("./World");
const Command_1 = require("./Command");
const Networks_1 = require("./Networks");
const Contract_1 = require("./Contract");
const ContractLookup_1 = require("./ContractLookup");
const Utils_1 = require("./Utils");
const Invokation_1 = require("./Invokation");
const Value_1 = require("./Value");
const CoreValue_1 = require("./CoreValue");
const typeMappings = () => ({
    address: {
        builder: (x) => new Value_1.AddressV(x),
        getter: CoreValue_1.getAddressV
    },
    'address[]': {
        builder: (x) => new Value_1.ArrayV(x),
        getter: (x) => CoreValue_1.getArrayV(x),
    },
    string: {
        builder: (x) => new Value_1.StringV(x),
        getter: CoreValue_1.getStringV
    },
    uint256: {
        builder: (x) => new Value_1.NumberV(x),
        getter: CoreValue_1.getNumberV
    },
    'uint256[]': {
        builder: (x) => new Value_1.ArrayV(x),
        getter: (x) => CoreValue_1.getArrayV(x),
    },
    'uint32[]': {
        builder: (x) => new Value_1.ArrayV(x),
        getter: (x) => CoreValue_1.getArrayV(x),
    },
    'uint96[]': {
        builder: (x) => new Value_1.ArrayV(x),
        getter: (x) => CoreValue_1.getArrayV(x),
    }
});
function buildArg(contractName, name, input) {
    let { getter } = typeMappings()[input.type] || {};
    if (!getter) {
        throw new Error(`Unknown ABI Input Type: ${input.type} of \`${name}\` in ${contractName}`);
    }
    return new Command_1.Arg(name, getter);
}
function getEventName(s) {
    return s.charAt(0).toUpperCase() + s.slice(1);
}
function getContractObjectFn(contractName, implicit) {
    if (implicit) {
        return async function getContractObject(world) {
            return ContractLookup_1.getWorldContract(world, [['Contracts', contractName]]);
        };
    }
    else {
        return async function getContractObject(world, event) {
            return ContractLookup_1.getWorldContract(world, [['Contracts', Utils_1.mustString(event)]]);
        };
    }
}
function buildContractEvent(contractName, implicit) {
    return async (world) => {
        let contractDeployer = Contract_1.getContract(contractName);
        let abis = await world.saddle.abi(contractName);
        async function build(world, from, params) {
            let constructors = abis.filter(({ type }) => type === 'constructor');
            if (constructors.length === 0) {
                constructors.push({
                    constant: false,
                    inputs: [],
                    outputs: [],
                    payable: true,
                    stateMutability: "payable",
                    type: 'constructor'
                });
            }
            const fetchers = constructors.map((abi) => {
                let nameArg = implicit ? [] : [
                    new Command_1.Arg('name', CoreValue_1.getStringV, { default: new Value_1.StringV(contractName) })
                ];
                let nameArgDesc = implicit ? `` : `name:<String>=${contractName}" `;
                let inputNames = abi.inputs.map((input) => getEventName(input.name));
                let args = abi.inputs.map((input) => buildArg(contractName, input.name, input));
                return new Command_1.Fetcher(`
            #### ${contractName}

            * "${contractName} ${nameArgDesc}${inputNames.join(" ")} - Build ${contractName}
              * E.g. "${contractName} Deploy"
            }
          `, contractName, nameArg.concat(args), async (world, paramValues) => {
                    let name = implicit ? contractName : paramValues['name'].val;
                    let params = args.map((arg) => paramValues[arg.name]); // TODO: This is just a guess
                    let paramsEncoded = params.map((param) => typeof (param['encode']) === 'function' ? param.encode() : param.val);
                    return {
                        invokation: await contractDeployer.deploy(world, from, paramsEncoded),
                        name: name,
                        contract: contractName
                    };
                }, { catchall: true });
            });
            let data = await Command_1.getFetcherValue(`Deploy${contractName}`, fetchers, world, params);
            let invokation = data.invokation;
            delete data.invokation;
            if (invokation.error) {
                throw invokation.error;
            }
            const contract = invokation.value;
            contract.address = contract._address;
            const index = contractName == data.name ? [contractName] : [contractName, data.name];
            world = await Networks_1.storeAndSaveContract(world, contract, data.name, invokation, [
                { index: index, data: data }
            ]);
            return { world, contract, data };
        }
        async function deploy(world, from, params) {
            let { world: nextWorld, contract, data } = await build(world, from, params);
            world = nextWorld;
            world = World_1.addAction(world, `Deployed ${contractName} ${data.contract} to address ${contract._address}`, data.invokation);
            return world;
        }
        function commands() {
            async function buildOutput(world, from, fn, inputs, output) {
                const sendable = (inputs['contract'].methods[fn](...Object.values(inputs).slice(1)));
                let invokation = await Invokation_1.invoke(world, sendable, from);
                world = World_1.addAction(world, `Invokation of ${fn} with inputs ${inputs}`, invokation);
                return world;
            }
            let abiCommands = abis.filter(({ type }) => type === 'function').map((abi) => {
                let eventName = getEventName(abi.name);
                let inputNames = abi.inputs.map((input) => getEventName(input.name));
                let args = [
                    new Command_1.Arg("contract", getContractObjectFn(contractName, implicit), implicit ? { implicit: true } : {})
                ].concat(abi.inputs.map((input) => buildArg(contractName, abi.name, input)));
                return new Command_1.Command(`
            #### ${eventName}

            * "${eventName} ${inputNames.join(" ")}" - Executes \`${abi.name}\` function
          `, eventName, args, (world, from, inputs) => buildOutput(world, from, abi.name, inputs, abi.outputs[0]), { namePos: implicit ? 0 : 1 });
            });
            return [
                ...abiCommands,
                new Command_1.Command(`
            #### ${contractName}

            * "${contractName} Deploy" - Deploy ${contractName}
              * E.g. "Counter Deploy"
          `, "Deploy", [
                    new Command_1.Arg("params", CoreValue_1.getEventV, { variadic: true })
                ], (world, from, { params }) => deploy(world, from, params.val))
            ];
        }
        async function processEvent(world, event, from) {
            return await Command_1.processCommandEvent(contractName, commands(), world, event, from);
        }
        let command = new Command_1.Command(`
        #### ${contractName}

        * "${contractName} ...event" - Runs given ${contractName} event
        * E.g. "${contractName} Deploy"
      `, contractName, [new Command_1.Arg('event', CoreValue_1.getEventV, { variadic: true })], (world, from, { event }) => {
            return processEvent(world, event.val, from);
        }, { subExpressions: commands() });
        return command;
    };
}
exports.buildContractEvent = buildContractEvent;
async function buildContractFetcher(world, contractName, implicit) {
    let abis = await world.saddle.abi(contractName);
    function fetchers() {
        async function buildOutput(world, fn, inputs, output) {
            const callable = (inputs['contract'].methods[fn](...Object.values(inputs).slice(1)));
            let value = await callable.call();
            let { builder } = typeMappings()[output.type] || {};
            if (!builder) {
                throw new Error(`Unknown ABI Output Type: ${output.type} of \`${fn}\` in ${contractName}`);
            }
            return builder(value);
        }
        return abis.filter(({ name }) => !!name).map((abi) => {
            let eventName = getEventName(abi.name);
            let inputNames = abi.inputs.map((input) => getEventName(input.name));
            let args = [
                new Command_1.Arg("contract", getContractObjectFn(contractName, implicit), implicit ? { implicit: true } : {})
            ].concat(abi.inputs.map((input) => buildArg(contractName, abi.name, input)));
            return new Command_1.Fetcher(`
          #### ${eventName}

          * "${eventName} ${inputNames.join(" ")}" - Returns the result of \`${abi.name}\` function
        `, eventName, args, (world, inputs) => buildOutput(world, abi.name, inputs, abi.outputs[0]), { namePos: implicit ? 0 : 1 });
        });
    }
    async function getValue(world, event) {
        return await Command_1.getFetcherValue(contractName, fetchers(), world, event);
    }
    let fetcher = new Command_1.Fetcher(`
      #### ${contractName}

      * "${contractName} ...args" - Returns ${contractName} value
    `, contractName, [new Command_1.Arg('res', getValue, { variadic: true })], async (world, { res }) => res, { subExpressions: fetchers() });
    return fetcher;
}
exports.buildContractFetcher = buildContractFetcher;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXZlbnRCdWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0V2ZW50QnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxtQ0FBMkM7QUFFM0MsdUNBQThGO0FBQzlGLHlDQUFrRDtBQUNsRCx5Q0FBbUQ7QUFDbkQscURBQW9EO0FBQ3BELG1DQUFxQztBQUNyQyw2Q0FBMEQ7QUFDMUQsbUNBT2lCO0FBQ2pCLDJDQU1xQjtBQVVyQixNQUFNLFlBQVksR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQzFCLE9BQU8sRUFBRTtRQUNQLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxnQkFBUSxDQUFDLENBQUMsQ0FBQztRQUMvQixNQUFNLEVBQUUsdUJBQVc7S0FDcEI7SUFDRCxXQUFXLEVBQUU7UUFDWCxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksY0FBTSxDQUFXLENBQUMsQ0FBQztRQUN2QyxNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLHFCQUFTLENBQVcsQ0FBQyxDQUFDO0tBQ3RDO0lBQ0QsTUFBTSxFQUFFO1FBQ04sT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLGVBQU8sQ0FBQyxDQUFDLENBQUM7UUFDOUIsTUFBTSxFQUFFLHNCQUFVO0tBQ25CO0lBQ0QsT0FBTyxFQUFFO1FBQ1AsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLGVBQU8sQ0FBQyxDQUFDLENBQUM7UUFDOUIsTUFBTSxFQUFFLHNCQUFVO0tBQ25CO0lBQ0QsV0FBVyxFQUFFO1FBQ1gsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLGNBQU0sQ0FBVSxDQUFDLENBQUM7UUFDdEMsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxxQkFBUyxDQUFVLENBQUMsQ0FBQztLQUNyQztJQUNE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QyxDQUFDO0lBQ2pGLENBQUM7SUFFRCxJQUFJLE9BQU8sR0FBRyxJQUFJLGlCQUFPLENBQ3ZCO2FBQ1MsWUFBWTs7V0FFZCxZQUFZLHVCQUF1QixZQUFZO0tBQ3JELEVBQ0QsWUFBWSxFQUNaLENBQUMsSUFBSSxhQUFHLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQzlDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLENBQUMsR0FBRyxFQUM3QixFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsRUFBRSxDQUMvQixDQUFBO0lBRUQsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQXJERCxvREFxREMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudCB9IGZyb20gJy4vRXZlbnQnO1xuaW1wb3J0IHsgYWRkQWN0aW9uLCBXb3JsZCB9IGZyb20gJy4vV29ybGQnO1xuaW1wb3J0IHsgSW52b2thdGlvbiB9IGZyb20gJy4vSW52b2thdGlvbic7XG5pbXBvcnQgeyBBcmcsIENvbW1hbmQsIEZldGNoZXIsIGdldEZldGNoZXJWYWx1ZSwgcHJvY2Vzc0NvbW1hbmRFdmVudCwgVmlldyB9IGZyb20gJy4vQ29tbWFuZCc7XG5pbXBvcnQgeyBzdG9yZUFuZFNhdmVDb250cmFjdCB9IGZyb20gJy4vTmV0d29ya3MnO1xuaW1wb3J0IHsgQ29udHJhY3QsIGdldENvbnRyYWN0IH0gZnJvbSAnLi9Db250cmFjdCc7XG5pbXBvcnQgeyBnZXRXb3JsZENvbnRyYWN0IH0gZnJvbSAnLi9Db250cmFjdExvb2t1cCc7XG5pbXBvcnQgeyBtdXN0U3RyaW5nIH0gZnJvbSAnLi9VdGlscyc7XG5pbXBvcnQgeyBDYWxsYWJsZSwgU2VuZGFibGUsIGludm9rZSB9IGZyb20gJy4vSW52b2thdGlvbic7XG5pbXBvcnQge1xuICBBZGRyZXNzVixcbiAgQXJyYXlWLFxuICBFdmVudFYsXG4gIE51bWJlclYsXG4gIFN0cmluZ1YsXG4gIFZhbHVlXG59IGZyb20gJy4vVmFsdWUnO1xuaW1wb3J0IHtcbiAgZ2V0QWRkcmVzc1YsXG4gIGdldEFycmF5VixcbiAgZ2V0RXZlbnRWLFxuICBnZXROdW1iZXJWLFxuICBnZXRTdHJpbmdWLFxufSBmcm9tICcuL0NvcmVWYWx1ZSc7XG5pbXBvcnQgeyBBYmlJdGVtLCBBYmlJbnB1dCB9IGZyb20gJ3dlYjMtdXRpbHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIENvbnRyYWN0RGF0YTxUPiB7XG4gIGludm9rYXRpb246IEludm9rYXRpb248VD47XG4gIG5hbWU6IHN0cmluZztcbiAgY29udHJhY3Q6IHN0cmluZztcbiAgYWRkcmVzcz86IHN0cmluZztcbn1cblxuY29uc3QgdHlwZU1hcHBpbmdzID0gKCkgPT4gKHtcbiAgYWRkcmVzczoge1xuICAgIGJ1aWxkZXI6ICh4KSA9PiBuZXcgQWRkcmVzc1YoeCksXG4gICAgZ2V0dGVyOiBnZXRBZGRyZXNzVlxuICB9LFxuICAnYWRkcmVzc1tdJzoge1xuICAgIGJ1aWxkZXI6ICh4KSA9PiBuZXcgQXJyYXlWPEFkZHJlc3NWPih4KSxcbiAgICBnZXR0ZXI6ICh4KSA9PiBnZXRBcnJheVY8QWRkcmVzc1Y+KHgpLFxuICB9LFxuICBzdHJpbmc6IHtcbiAgICBidWlsZGVyOiAoeCkgPT4gbmV3IFN0cmluZ1YoeCksXG4gICAgZ2V0dGVyOiBnZXRTdHJpbmdWXG4gIH0sXG4gIHVpbnQyNTY6IHtcbiAgICBidWlsZGVyOiAoeCkgPT4gbmV3IE51bWJlclYoeCksXG4gICAgZ2V0dGVyOiBnZXROdW1iZXJWXG4gIH0sXG4gICd1aW50MjU2W10nOiB7XG4gICAgYnVpbGRlcjogKHgpID0+IG5ldyBBcnJheVY8TnVtYmVyVj4oeCksXG4gICAgZ2V0dGVyOiAoeCkgPT4gZ2V0QXJyYXlWPE51bWJlclY+KHgpLFxuICB9LFxuICAndWludDMyW10nOiB7XG4gICAgYnVpbGRlcjogKHgpID0+IG5ldyBBcnJheVY8TnVtYmVyVj4oeCksXG4gICAgZ2V0dGVyOiAoeCkgPT4gZ2V0QXJyYXlWPE51bWJlclY+KHgpLFxuICB9LFxuICAndWludDk2W10nOiB7XG4gICAgYnVpbGRlcjogKHgpID0+IG5ldyBBcnJheVY8TnVtYmVyVj4oeCksXG4gICAgZ2V0dGVyOiAoeCkgPT4gZ2V0QXJyYXlWPE51bWJlclY+KHgpLFxuICB9XG59KTtcblxuZnVuY3Rpb24gYnVpbGRBcmcoY29udHJhY3ROYW1lOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgaW5wdXQ6IEFiaUlucHV0KTogQXJnPFZhbHVlPiB7XG4gIGxldCB7IGdldHRlciB9ID0gdHlwZU1hcHBpbmdzKClbaW5wdXQudHlwZV0gfHwge307XG5cbiAgaWYgKCFnZXR0ZXIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gQUJJIElucHV0IFR5cGU6ICR7aW5wdXQudHlwZX0gb2YgXFxgJHtuYW1lfVxcYCBpbiAke2NvbnRyYWN0TmFtZX1gKTtcbiAgfVxuXG4gIHJldHVybiBuZXcgQXJnKG5hbWUsIGdldHRlcik7XG59XG5cbmZ1bmN0aW9uIGdldEV2ZW50TmFtZShzKSB7XG4gIHJldHVybiBzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcy5zbGljZSgxKTtcbn1cblxuZnVuY3Rpb24gZ2V0Q29udHJhY3RPYmplY3RGbihjb250cmFjdE5hbWUsIGltcGxpY2l0KSB7XG4gIGlmIChpbXBsaWNpdCkge1xuICAgIHJldHVybiBhc3luYyBmdW5jdGlvbiBnZXRDb250cmFjdE9iamVjdCh3b3JsZDogV29ybGQpOiBQcm9taXNlPENvbnRyYWN0PiB7XG4gICAgICByZXR1cm4gZ2V0V29ybGRDb250cmFjdCh3b3JsZCwgW1snQ29udHJhY3RzJywgY29udHJhY3ROYW1lXV0pO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXN5bmMgZnVuY3Rpb24gZ2V0Q29udHJhY3RPYmplY3Qod29ybGQ6IFdvcmxkLCBldmVudDogRXZlbnQpOiBQcm9taXNlPENvbnRyYWN0PiB7XG4gICAgICByZXR1cm4gZ2V0V29ybGRDb250cmFjdCh3b3JsZCwgW1snQ29udHJhY3RzJywgbXVzdFN0cmluZyhldmVudCldXSk7XG4gICAgfVxuICB9XG59XG5leHBvcnQgZnVuY3Rpb24gYnVpbGRDb250cmFjdEV2ZW50PFQgZXh0ZW5kcyBDb250cmFjdD4oY29udHJhY3ROYW1lOiBzdHJpbmcsIGltcGxpY2l0KSB7XG5cblxuICByZXR1cm4gYXN5bmMgKHdvcmxkKSA9PiB7XG4gICAgbGV0IGNvbnRyYWN0RGVwbG95ZXIgPSBnZXRDb250cmFjdChjb250cmFjdE5hbWUpO1xuICAgIGxldCBhYmlzOiBBYmlJdGVtW10gPSBhd2FpdCB3b3JsZC5zYWRkbGUuYWJpKGNvbnRyYWN0TmFtZSk7XG5cbiAgICBhc3luYyBmdW5jdGlvbiBidWlsZDxUIGV4dGVuZHMgQ29udHJhY3Q+KFxuICAgICAgd29ybGQ6IFdvcmxkLFxuICAgICAgZnJvbTogc3RyaW5nLFxuICAgICAgcGFyYW1zOiBFdmVudFxuICAgICk6IFByb21pc2U8eyB3b3JsZDogV29ybGQ7IGNvbnRyYWN0OiBUOyBkYXRhOiBDb250cmFjdERhdGE8VD4gfT4ge1xuICAgICAgbGV0IGNvbnN0cnVjdG9ycyA9IGFiaXMuZmlsdGVyKCh7dHlwZX0pID0+IHR5cGUgPT09ICdjb25zdHJ1Y3RvcicpO1xuICAgICAgaWYgKGNvbnN0cnVjdG9ycy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgY29uc3RydWN0b3JzLnB1c2goe1xuICAgICAgICAgIGNvbnN0YW50OiBmYWxzZSxcbiAgICAgICAgICBpbnB1dHM6IFtdLFxuICAgICAgICAgIG91dHB1dHM6IFtdLFxuICAgICAgICAgIHBheWFibGU6IHRydWUsXG4gICAgICAgICAgc3RhdGVNdXRhYmlsaXR5OiBcInBheWFibGVcIixcbiAgICAgICAgICB0eXBlOiAnY29uc3RydWN0b3InXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBmZXRjaGVycyA9IGNvbnN0cnVjdG9ycy5tYXAoKGFiaTogYW55KSA9PiB7XG4gICAgICAgIGxldCBuYW1lQXJnID0gaW1wbGljaXQgPyBbXSA6IFtcbiAgICAgICAgICBuZXcgQXJnKCduYW1lJywgZ2V0U3RyaW5nViwgeyBkZWZhdWx0OiBuZXcgU3RyaW5nVihjb250cmFjdE5hbWUpIH0pXG4gICAgICAgIF07XG4gICAgICAgIGxldCBuYW1lQXJnRGVzYyA9IGltcGxpY2l0ID8gYGAgOiBgbmFtZTo8U3RyaW5nPj0ke2NvbnRyYWN0TmFtZX1cIiBgXG4gICAgICAgIGxldCBpbnB1dE5hbWVzID0gYWJpLmlucHV0cy5tYXAoKGlucHV0KSA9PiBnZXRFdmVudE5hbWUoaW5wdXQubmFtZSkpO1xuICAgICAgICBsZXQgYXJncyA9IGFiaS5pbnB1dHMubWFwKChpbnB1dCkgPT4gYnVpbGRBcmcoY29udHJhY3ROYW1lLCBpbnB1dC5uYW1lLCBpbnB1dCkpO1xuICAgICAgICByZXR1cm4gbmV3IEZldGNoZXI8b2JqZWN0LCBDb250cmFjdERhdGE8VD4+KFxuICAgICAgICAgIGBcbiAgICAgICAgICAgICMjIyMgJHtjb250cmFjdE5hbWV9XG5cbiAgICAgICAgICAgICogXCIke2NvbnRyYWN0TmFtZX0gJHtuYW1lQXJnRGVzY30ke2lucHV0TmFtZXMuam9pbihcIiBcIil9IC0gQnVpbGQgJHtjb250cmFjdE5hbWV9XG4gICAgICAgICAgICAgICogRS5nLiBcIiR7Y29udHJhY3ROYW1lfSBEZXBsb3lcIlxuICAgICAgICAgICAgfVxuICAgICAgICAgIGAsXG4gICAgICAgICAgY29udHJhY3ROYW1lLFxuICAgICAgICAgIG5hbWVBcmcuY29uY2F0KGFyZ3MpLFxuICAgICAgICAgIGFzeW5jICh3b3JsZCwgcGFyYW1WYWx1ZXMpID0+IHtcbiAgICAgICAgICAgIGxldCBuYW1lID0gaW1wbGljaXQgPyBjb250cmFjdE5hbWUgOiA8c3RyaW5nPnBhcmFtVmFsdWVzWyduYW1lJ10udmFsO1xuICAgICAgICAgICAgbGV0IHBhcmFtcyA9IGFyZ3MubWFwKChhcmcpID0+IHBhcmFtVmFsdWVzW2FyZy5uYW1lXSk7IC8vIFRPRE86IFRoaXMgaXMganVzdCBhIGd1ZXNzXG4gICAgICAgICAgICBsZXQgcGFyYW1zRW5jb2RlZCA9IHBhcmFtcy5tYXAoKHBhcmFtKSA9PiB0eXBlb2YocGFyYW1bJ2VuY29kZSddKSA9PT0gJ2Z1bmN0aW9uJyA/IHBhcmFtLmVuY29kZSgpIDogcGFyYW0udmFsKTtcblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgaW52b2thdGlvbjogYXdhaXQgY29udHJhY3REZXBsb3llci5kZXBsb3k8VD4od29ybGQsIGZyb20sIHBhcmFtc0VuY29kZWQpLFxuICAgICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgICBjb250cmFjdDogY29udHJhY3ROYW1lXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0sXG4gICAgICAgICAgeyBjYXRjaGFsbDogdHJ1ZSB9XG4gICAgICAgIClcbiAgICAgIH0pO1xuXG4gICAgICBsZXQgZGF0YSA9IGF3YWl0IGdldEZldGNoZXJWYWx1ZTxhbnksIENvbnRyYWN0RGF0YTxUPj4oYERlcGxveSR7Y29udHJhY3ROYW1lfWAsIGZldGNoZXJzLCB3b3JsZCwgcGFyYW1zKTtcbiAgICAgIGxldCBpbnZva2F0aW9uID0gZGF0YS5pbnZva2F0aW9uO1xuICAgICAgZGVsZXRlIGRhdGEuaW52b2thdGlvbjtcblxuICAgICAgaWYgKGludm9rYXRpb24uZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgaW52b2thdGlvbi5lcnJvcjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY29udHJhY3QgPSBpbnZva2F0aW9uLnZhbHVlITtcbiAgICAgIGNvbnRyYWN0LmFkZHJlc3MgPSBjb250cmFjdC5fYWRkcmVzcztcbiAgICAgIGNvbnN0IGluZGV4ID0gY29udHJhY3ROYW1lID09IGRhdGEubmFtZSA/IFtjb250cmFjdE5hbWVdIDogW2NvbnRyYWN0TmFtZSwgZGF0YS5uYW1lXTtcblxuICAgICAgd29ybGQgPSBhd2FpdCBzdG9yZUFuZFNhdmVDb250cmFjdChcbiAgICAgICAgd29ybGQsXG4gICAgICAgIGNvbnRyYWN0LFxuICAgICAgICBkYXRhLm5hbWUsXG4gICAgICAgIGludm9rYXRpb24sXG4gICAgICAgIFtcbiAgICAgICAgICB7IGluZGV4OiBpbmRleCwgZGF0YTogZGF0YSB9XG4gICAgICAgIF1cbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB7IHdvcmxkLCBjb250cmFjdCwgZGF0YSB9O1xuICAgIH1cblxuICAgIGFzeW5jIGZ1bmN0aW9uIGRlcGxveTxUIGV4dGVuZHMgQ29udHJhY3Q+KHdvcmxkOiBXb3JsZCwgZnJvbTogc3RyaW5nLCBwYXJhbXM6IEV2ZW50KSB7XG4gICAgICBsZXQgeyB3b3JsZDogbmV4dFdvcmxkLCBjb250cmFjdCwgZGF0YSB9ID0gYXdhaXQgYnVpbGQ8VD4od29ybGQsIGZyb20sIHBhcmFtcyk7XG4gICAgICB3b3JsZCA9IG5leHRXb3JsZDtcblxuICAgICAgd29ybGQgPSBhZGRBY3Rpb24oXG4gICAgICAgIHdvcmxkLFxuICAgICAgICBgRGVwbG95ZWQgJHtjb250cmFjdE5hbWV9ICR7ZGF0YS5jb250cmFjdH0gdG8gYWRkcmVzcyAke2NvbnRyYWN0Ll9hZGRyZXNzfWAsXG4gICAgICAgIGRhdGEuaW52b2thdGlvblxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHdvcmxkO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGNvbW1hbmRzPFQgZXh0ZW5kcyBDb250cmFjdD4oKSB7XG4gICAgICBhc3luYyBmdW5jdGlvbiBidWlsZE91dHB1dCh3b3JsZDogV29ybGQsIGZyb206IHN0cmluZywgZm46IHN0cmluZywgaW5wdXRzOiBvYmplY3QsIG91dHB1dDogQWJpSXRlbSk6IFByb21pc2U8V29ybGQ+IHtcbiAgICAgICAgY29uc3Qgc2VuZGFibGUgPSA8U2VuZGFibGU8YW55Pj4oaW5wdXRzWydjb250cmFjdCddLm1ldGhvZHNbZm5dKC4uLk9iamVjdC52YWx1ZXMoaW5wdXRzKS5zbGljZSgxKSkpO1xuICAgICAgICBsZXQgaW52b2thdGlvbiA9IGF3YWl0IGludm9rZSh3b3JsZCwgc2VuZGFibGUsIGZyb20pO1xuXG4gICAgICAgIHdvcmxkID0gYWRkQWN0aW9uKFxuICAgICAgICAgIHdvcmxkLFxuICAgICAgICAgIGBJbnZva2F0aW9uIG9mICR7Zm59IHdpdGggaW5wdXRzICR7aW5wdXRzfWAsXG4gICAgICAgICAgaW52b2thdGlvblxuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiB3b3JsZDtcbiAgICAgIH1cblxuICAgICAgbGV0IGFiaUNvbW1hbmRzID0gYWJpcy5maWx0ZXIoKHt0eXBlfSkgPT4gdHlwZSA9PT0gJ2Z1bmN0aW9uJykubWFwKChhYmk6IGFueSkgPT4ge1xuICAgICAgICBsZXQgZXZlbnROYW1lID0gZ2V0RXZlbnROYW1lKGFiaS5uYW1lKTtcbiAgICAgICAgbGV0IGlucHV0TmFtZXMgPSBhYmkuaW5wdXRzLm1hcCgoaW5wdXQpID0+IGdldEV2ZW50TmFtZShpbnB1dC5uYW1lKSk7XG4gICAgICAgIGxldCBhcmdzID0gW1xuICAgICAgICAgIG5ldyBBcmcoXCJjb250cmFjdFwiLCBnZXRDb250cmFjdE9iamVjdEZuKGNvbnRyYWN0TmFtZSwgaW1wbGljaXQpLCBpbXBsaWNpdCA/IHsgaW1wbGljaXQ6IHRydWUgfSA6IHt9KVxuICAgICAgICBdLmNvbmNhdChhYmkuaW5wdXRzLm1hcCgoaW5wdXQpID0+IGJ1aWxkQXJnKGNvbnRyYWN0TmFtZSwgYWJpLm5hbWUsIGlucHV0KSkpO1xuXG4gICAgICAgIHJldHVybiBuZXcgQ29tbWFuZDxvYmplY3Q+KGBcbiAgICAgICAgICAgICMjIyMgJHtldmVudE5hbWV9XG5cbiAgICAgICAgICAgICogXCIke2V2ZW50TmFtZX0gJHtpbnB1dE5hbWVzLmpvaW4oXCIgXCIpfVwiIC0gRXhlY3V0ZXMgXFxgJHthYmkubmFtZX1cXGAgZnVuY3Rpb25cbiAgICAgICAgICBgLFxuICAgICAgICAgIGV2ZW50TmFtZSxcbiAgICAgICAgICBhcmdzLFxuICAgICAgICAgICh3b3JsZCwgZnJvbSwgaW5wdXRzKSA9PiBidWlsZE91dHB1dCh3b3JsZCwgZnJvbSwgYWJpLm5hbWUsIGlucHV0cywgYWJpLm91dHB1dHNbMF0pLFxuICAgICAgICAgIHsgbmFtZVBvczogaW1wbGljaXQgPyAwIDogMSB9XG4gICAgICAgIClcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gW1xuICAgICAgICAuLi5hYmlDb21tYW5kcyxcbiAgICAgICAgbmV3IENvbW1hbmQ8eyBwYXJhbXM6IEV2ZW50ViB9PihgXG4gICAgICAgICAgICAjIyMjICR7Y29udHJhY3ROYW1lfVxuXG4gICAgICAgICAgICAqIFwiJHtjb250cmFjdE5hbWV9IERlcGxveVwiIC0gRGVwbG95ICR7Y29udHJhY3ROYW1lfVxuICAgICAgICAgICAgICAqIEUuZy4gXCJDb3VudGVyIERlcGxveVwiXG4gICAgICAgICAgYCxcbiAgICAgICAgICBcIkRlcGxveVwiLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgIG5ldyBBcmcoXCJwYXJhbXNcIiwgZ2V0RXZlbnRWLCB7IHZhcmlhZGljOiB0cnVlIH0pXG4gICAgICAgICAgXSxcbiAgICAgICAgICAod29ybGQsIGZyb20sIHsgcGFyYW1zIH0pID0+IGRlcGxveTxUPih3b3JsZCwgZnJvbSwgcGFyYW1zLnZhbClcbiAgICAgICAgKVxuICAgICAgXTtcbiAgICB9XG5cbiAgICBhc3luYyBmdW5jdGlvbiBwcm9jZXNzRXZlbnQod29ybGQ6IFdvcmxkLCBldmVudDogRXZlbnQsIGZyb206IHN0cmluZyB8IG51bGwpOiBQcm9taXNlPFdvcmxkPiB7XG4gICAgICByZXR1cm4gYXdhaXQgcHJvY2Vzc0NvbW1hbmRFdmVudDxhbnk+KGNvbnRyYWN0TmFtZSwgY29tbWFuZHMoKSwgd29ybGQsIGV2ZW50LCBmcm9tKTtcbiAgICB9XG5cbiAgICBsZXQgY29tbWFuZCA9IG5ldyBDb21tYW5kPHsgZXZlbnQ6IEV2ZW50ViB9PihcbiAgICAgIGBcbiAgICAgICAgIyMjIyAke2NvbnRyYWN0TmFtZX1cblxuICAgICAgICAqIFwiJHtjb250cmFjdE5hbWV9IC4uLmV2ZW50XCIgLSBSdW5zIGdpdmVuICR7Y29udHJhY3ROYW1lfSBldmVudFxuICAgICAgICAqIEUuZy4gXCIke2NvbnRyYWN0TmFtZX0gRGVwbG95XCJcbiAgICAgIGAsXG4gICAgICBjb250cmFjdE5hbWUsXG4gICAgICBbbmV3IEFyZygnZXZlbnQnLCBnZXRFdmVudFYsIHsgdmFyaWFkaWM6IHRydWUgfSldLFxuICAgICAgKHdvcmxkLCBmcm9tLCB7IGV2ZW50IH0pID0+IHtcbiAgICAgICAgcmV0dXJuIHByb2Nlc3NFdmVudCh3b3JsZCwgZXZlbnQudmFsLCBmcm9tKTtcbiAgICAgIH0sXG4gICAgICB7IHN1YkV4cHJlc3Npb25zOiBjb21tYW5kcygpIH1cbiAgICApO1xuXG4gICAgcmV0dXJuIGNvbW1hbmQ7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGJ1aWxkQ29udHJhY3RGZXRjaGVyPFQgZXh0ZW5kcyBDb250cmFjdD4od29ybGQ6IFdvcmxkLCBjb250cmFjdE5hbWU6IHN0cmluZywgaW1wbGljaXQ6IGJvb2xlYW4pIHtcblxuICBsZXQgYWJpczogQWJpSXRlbVtdID0gYXdhaXQgd29ybGQuc2FkZGxlLmFiaShjb250cmFjdE5hbWUpO1xuXG4gIGZ1bmN0aW9uIGZldGNoZXJzKCkge1xuICAgIGFzeW5jIGZ1bmN0aW9uIGJ1aWxkT3V0cHV0KHdvcmxkOiBXb3JsZCwgZm46IHN0cmluZywgaW5wdXRzOiBvYmplY3QsIG91dHB1dDogQWJpSXRlbSk6IFByb21pc2U8VmFsdWU+IHtcbiAgICAgIGNvbnN0IGNhbGxhYmxlID0gPENhbGxhYmxlPGFueT4+KGlucHV0c1snY29udHJhY3QnXS5tZXRob2RzW2ZuXSguLi5PYmplY3QudmFsdWVzKGlucHV0cykuc2xpY2UoMSkpKTtcbiAgICAgIGxldCB2YWx1ZSA9IGF3YWl0IGNhbGxhYmxlLmNhbGwoKTtcbiAgICAgIGxldCB7IGJ1aWxkZXIgfSA9IHR5cGVNYXBwaW5ncygpW291dHB1dC50eXBlXSB8fCB7fTtcblxuICAgICAgaWYgKCFidWlsZGVyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBBQkkgT3V0cHV0IFR5cGU6ICR7b3V0cHV0LnR5cGV9IG9mIFxcYCR7Zm59XFxgIGluICR7Y29udHJhY3ROYW1lfWApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gYnVpbGRlcih2YWx1ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFiaXMuZmlsdGVyKCh7bmFtZX0pID0+ICEhbmFtZSkubWFwKChhYmk6IGFueSkgPT4ge1xuICAgICAgbGV0IGV2ZW50TmFtZSA9IGdldEV2ZW50TmFtZShhYmkubmFtZSk7XG4gICAgICBsZXQgaW5wdXROYW1lcyA9IGFiaS5pbnB1dHMubWFwKChpbnB1dCkgPT4gZ2V0RXZlbnROYW1lKGlucHV0Lm5hbWUpKTtcbiAgICAgIGxldCBhcmdzID0gW1xuICAgICAgICBuZXcgQXJnKFwiY29udHJhY3RcIiwgZ2V0Q29udHJhY3RPYmplY3RGbihjb250cmFjdE5hbWUsIGltcGxpY2l0KSwgaW1wbGljaXQgPyB7IGltcGxpY2l0OiB0cnVlIH0gOiB7fSlcbiAgICAgIF0uY29uY2F0KGFiaS5pbnB1dHMubWFwKChpbnB1dCkgPT4gYnVpbGRBcmcoY29udHJhY3ROYW1lLCBhYmkubmFtZSwgaW5wdXQpKSk7XG4gICAgICByZXR1cm4gbmV3IEZldGNoZXI8b2JqZWN0LCBWYWx1ZT4oYFxuICAgICAgICAgICMjIyMgJHtldmVudE5hbWV9XG5cbiAgICAgICAgICAqIFwiJHtldmVudE5hbWV9ICR7aW5wdXROYW1lcy5qb2luKFwiIFwiKX1cIiAtIFJldHVybnMgdGhlIHJlc3VsdCBvZiBcXGAke2FiaS5uYW1lfVxcYCBmdW5jdGlvblxuICAgICAgICBgLFxuICAgICAgICBldmVudE5hbWUsXG4gICAgICAgIGFyZ3MsXG4gICAgICAgICh3b3JsZCwgaW5wdXRzKSA9PiBidWlsZE91dHB1dCh3b3JsZCwgYWJpLm5hbWUsIGlucHV0cywgYWJpLm91dHB1dHNbMF0pLFxuICAgICAgICB7IG5hbWVQb3M6IGltcGxpY2l0ID8gMCA6IDEgfVxuICAgICAgKVxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZnVuY3Rpb24gZ2V0VmFsdWUod29ybGQ6IFdvcmxkLCBldmVudDogRXZlbnQpOiBQcm9taXNlPFZhbHVlPiB7XG4gICAgcmV0dXJuIGF3YWl0IGdldEZldGNoZXJWYWx1ZTxhbnksIGFueT4oY29udHJhY3ROYW1lLCBmZXRjaGVycygpLCB3b3JsZCwgZXZlbnQpO1xuICB9XG5cbiAgbGV0IGZldGNoZXIgPSBuZXcgRmV0Y2hlcjx7IHJlczogVmFsdWUgfSwgVmFsdWU+KFxuICAgIGBcbiAgICAgICMjIyMgJHtjb250cmFjdE5hbWV9XG5cbiAgICAgICogXCIke2NvbnRyYWN0TmFtZX0gLi4uYXJnc1wiIC0gUmV0dXJucyAke2NvbnRyYWN0TmFtZX0gdmFsdWVcbiAgICBgLFxuICAgIGNvbnRyYWN0TmFtZSxcbiAgICBbbmV3IEFyZygncmVzJywgZ2V0VmFsdWUsIHsgdmFyaWFkaWM6IHRydWUgfSldLFxuICAgIGFzeW5jICh3b3JsZCwgeyByZXMgfSkgPT4gcmVzLFxuICAgIHsgc3ViRXhwcmVzc2lvbnM6IGZldGNoZXJzKCkgfVxuICApXG5cbiAgcmV0dXJuIGZldGNoZXI7XG59XG4iXX0=